model Quiz {
  id         String   @id @default(cuid())
  title      String
  documentId String
  createdAt  DateTime @default(now())

  document  Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)
  questions QuizQuestion[]

  @@index([documentId])
}

model QuizQuestion {
  id            String  @id @default(cuid())
  quizId        String
  questionText  String
  options       Json?
  correctIndex   Int?
  correctIndices Json?
  correctAnswer  String?
  explanation   String?
  sourceChunkId String?
  sourceSnippet String?
  questionIndex Int
  questionType  String  @default("singleChoice")

  quiz        Quiz           @relation(fields: [quizId], references: [id], onDelete: Cascade)
  sourceChunk DocumentChunk? @relation(fields: [sourceChunkId], references: [id], onDelete: SetNull)
  attempts    QuizAttempt[]
  progress    QuestionProgress?
  flashcards  Flashcard[]

  @@index([quizId])
}

model QuizAttempt {
  id               String   @id @default(cuid())
  questionId       String
  selectedIndex    Int?
  selectedIndices  Json?
  isCorrect        Boolean
  explanation      String?
  freeTextAnswer   String?
  freeTextScore    Float?
  freeTextFeedback String?
  createdAt        DateTime @default(now())

  question QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

model QuestionProgress {
  id             String    @id @default(cuid())
  questionId     String    @unique
  easeFactor     Float     @default(2.5)
  interval       Int       @default(1)
  repetitions    Int       @default(0)
  nextReviewAt   DateTime
  lastReviewedAt DateTime?

  question QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([nextReviewAt])
}
